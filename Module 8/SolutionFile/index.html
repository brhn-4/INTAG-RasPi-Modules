<!-- 
########################################################################
# Filename    : index.html
# Description : html web page with flask and ajax to dynamically update
                page with sensor data and update user on any breaches
                of ideal paramaters
# Author      : brhn
# modification: 8/10/2023
########################################################################
 -->




<!DOCTYPE html>
<html>
<head>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  <!-- link ajax -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
     integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">  <!--link bootstrap !-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> <!-- link bootstrap !-->
    <link rel = 'stylesheet' href="/index.css"> <!-- link css!-->
    <title>INTAG RasPi Web Server</title>  <!-- title !-->
</head>
<body>
  <div class="navbar">   <!-- navbar class for css !-->
    <h1>INTAG Systems</h1>
    <div class ='clock' id="liveClock">00:00</div>
    <div id="lastUpdate" style="position: absolute; left: 10px; top: 10px;">  <!-- clock with id for js!-->
        Last Update at: <span id="updateTime">00:00:00</span>  <!-- last update elem !-->
    </div>
</div>

<div class="container jumbotron-container">  <!-- jumbotron container for  css !-->

    <div class="jumbotron">
        <h2 style="text-align:center"><u>Ideal Parameters</u></h2>  <!-- ideal paramaters jumbo !-->
        <div class="row">
            <div class="col-sm box">
                <h4>Water Temperature</h4>
                <div class='iparam'>70F - 85F</div>
            </div>
        </div>

        <div class = 'row'>
            <div class="col-sm box">
                <h4>Air Temperature</h4>
                <div class ='iparam'>70F - 85F</div>
            </div>
        </div>
            
        
        <div class="row">
            <div class="col-sm box">
                <h4>Humidity</h4>
                <div class ='iparam'>45% - 60%</div>
            </div>
        </div>
        
    </div>

    <div class="jumbotron">
        <h2 style="text-align:center"><u>Last Reading</u></h2>
        <div class="row">
            <div class="col-sm box">
                <h4>Water Temperature</h4>
                <div id = 'waterTemperature'></div>
            </div>
        </div>

        <div class = 'row'>
            <div class="col-sm box">
                <h4>Air Temperature</h4>
                <div id='airTemperature'></div>
            </div>
        </div>
            
        
        <div class="row">
            <div class="col-sm box">
                <h4>Humidity</h4>
                <div id = 'humidity'></div>
            </div>
        </div>
        
    </div>
</div>


 




<script>
    
function fetchData() {  //fetch sensor data fcn 
    $.ajax({
        url: 'http://10.0.0.51:5000/get_data', //url for viewing server 
        type: 'GET',
        success: function(response) { //if success push these results from json obj 'response'
            updateDOM('#airTemperature', response.air_temperature, "Air Temperature", 70, 85);  //update DOM elems
            updateDOM('#waterTemperature', response.water_temperature, "Water Temperature", 70, 85);
            updateDOM('#humidity', response.humidity, "Humidity", 45, 60);

               // Update the timestamp on data fetch
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();

            // Format time as 2-digit values, prepending with 0 if necessary
            hours = ("0" + hours).slice(-2);
            minutes = ("0" + minutes).slice(-2);
            seconds = ("0" + seconds).slice(-2);

            $('#updateTime').text(hours + ":" + minutes + ":" + seconds);
 
        },
        error: function(error) { //error catch
            console.log(error);
        }
    });
}
fetchData(); //call fetch fcn
setInterval(fetchData, 5000); // Refresh data every 5 seconds


let parameterState = {
    'airTemperature': true,  // true implies it's in-bounds, false means out-of-bounds
    'waterTemperature': true,
    'humidity': true
};

function updateDOM(elementId, valueString, name, lowerBound, upperBound) { //update dom for out-of-bounds
    let value = parseFloat(valueString.split(' ')[0]);
    $(elementId).text(name + ": " + valueString);

    let isWithinBounds = value >= lowerBound && value <= upperBound;

    if (!isWithinBounds) { //out-of-bounds
        $(elementId).css('color', 'red');
        if (parameterState[name]) {
            alert(`${name} is out of bounds! Value: ${value}`);
            parameterState[name] = false;  // Update state to out-of-bounds
        }
    } else { //in-bounds
        $(elementId).css('color', 'black');
        parameterState[name] = true;  // Update state to in-bounds
    }
}









function updateClock(){ //clock fcn
    var now = new Date();
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var seconds = now.getSeconds();

    // Format time as 2-digit values, prepending with 0 if necessary
    hours = ("0" + hours).slice(-2);
    minutes = ("0" + minutes).slice(-2);
    seconds = ("0" + seconds).slice(-2);

    document.getElementById('liveClock').innerHTML = hours + ":" + minutes + ":" + seconds;
}

setInterval(updateClock, 1000); //clock interval
  
</script>

</body>
</html>
